"use strict";(self.webpackChunkrsbuild_website=self.webpackChunkrsbuild_website||[]).push([["3073"],{80876:function(e,n,s){s.r(n),s.d(n,{default:function(){return a}});var r=s(55367),d=s(26971);function i(e){let n=Object.assign({h1:"h1",a:"a",ul:"ul",li:"li",strong:"strong",pre:"pre",code:"code",p:"p",h2:"h2",h3:"h3"},(0,d.ah)(),e.components);return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)(n.h1,{id:"devsetupmiddlewares",children:["dev.setupMiddlewares",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#devsetupmiddlewares",children:"#"})]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.strong,{children:"类型："})}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"type SetupMiddlewaresServer = {\n  sockWrite: (\n    type: string,\n    data?: string | boolean | Record<string, any>,\n  ) => void;\n  environments: EnvironmentAPI;\n};\n\ntype SetupMiddlewares = Array<\n  (\n    middlewares: {\n      unshift: (...handlers: RequestHandler[]) => void;\n      push: (...handlers: RequestHandler[]) => void;\n    },\n    server: SetupMiddlewaresServer,\n  ) => void\n>;\n"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"默认值："})," ",(0,r.jsx)(n.code,{children:"undefined"})]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"提供执行自定义函数和应用自定义中间件的能力。"}),"\n",(0,r.jsxs)(n.h2,{id:"执行顺序",children:["执行顺序",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#执行顺序",children:"#"})]}),"\n",(0,r.jsxs)(n.p,{children:["中间件的执行顺序是: ",(0,r.jsx)(n.code,{children:"unshift"})," => 内置中间件 => ",(0,r.jsx)(n.code,{children:"push"}),"。"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-js",children:"export default {\n  dev: {\n    setupMiddlewares: [\n      (middlewares, server) => {\n        middlewares.unshift((req, res, next) => {\n          console.log('first');\n          next();\n        });\n\n        middlewares.push((req, res, next) => {\n          console.log('last');\n          next();\n        });\n      },\n    ],\n  },\n};\n"})}),"\n",(0,r.jsxs)(n.h2,{id:"server-api",children:["Server API",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#server-api",children:"#"})]}),"\n",(0,r.jsxs)(n.p,{children:["在 ",(0,r.jsx)(n.code,{children:"setupMiddlewares"})," 函数中，你可以访问到 ",(0,r.jsx)(n.code,{children:"server"})," 对象，该对象提供了一些服务器 API。"]}),"\n",(0,r.jsxs)(n.h3,{id:"sockwrite",children:["sockWrite",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#sockwrite",children:"#"})]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"sockWrite"})," 允许中间件向 HMR 客户端传递一些消息，HMR 客户端将根据接收到的消息类型进行不同的处理。"]}),"\n",(0,r.jsxs)(n.p,{children:["例如，如果你发送一个 ",(0,r.jsx)(n.code,{children:"'content-changed'"})," 的消息，页面将会重新加载。"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-js",children:"export default {\n  dev: {\n    setupMiddlewares: [\n      (middlewares, server) => {\n        if (someCondition) {\n          server.sockWrite('content-changed');\n        }\n      },\n    ],\n  },\n};\n"})}),"\n",(0,r.jsxs)(n.h3,{id:"environments",children:["environments",(0,r.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#environments",children:"#"})]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"environments"})," 包含 Rsbuild 的 ",(0,r.jsx)(n.a,{href:"/api/javascript-api/environment-api#environment-api",children:"environment API"}),"，这允许你在服务端获取特定环境下的构建产物信息。"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"export default {\n  dev: {\n    setupMiddlewares: [\n      (middlewares, server) => {\n        middlewares.unshift(async (req, _res, next) => {\n          const webStats = await server.environments.web.getStats();\n\n          console.log(webStats.toJson({ all: false }));\n\n          next();\n        });\n      },\n    ],\n  },\n};\n"})})]})}function t(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{wrapper:n}=Object.assign({},(0,d.ah)(),e.components);return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(i,{...e})}):i(e)}let a=t;t.__RSPRESS_PAGE_META={},t.__RSPRESS_PAGE_META["zh%2Fconfig%2Fdev%2Fsetup-middlewares.mdx"]={toc:[{text:"执行顺序",id:"执行顺序",depth:2},{text:"Server API",id:"server-api",depth:2},{text:"sockWrite",id:"sockwrite",depth:3},{text:"environments",id:"environments",depth:3}],title:"dev.setupMiddlewares",frontmatter:{}}}}]);